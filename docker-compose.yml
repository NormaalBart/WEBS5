version: '3.8'

services:
  apigateway:
    build:
      context: ./apigateway
      dockerfile: /Dockerfile
    volumes:
      - ./apigateway:/app
    ports:
      - "3000:3000"
    environment:
      - "IMAGE_SERVICE=http://imageservice:5672/"
      - "AUTH_SERVICE=http://authservice:5672/"
      - "TARGET_SERVICE=http://targetservice:5672/"
    restart: always
  imageservice:
    build:
      context: ./imageservice
      dockerfile: /Dockerfile
    volumes:
      - ./imageservice:/app
      - ./data/images:/app/images
    depends_on:
      - imageservicedb
    environment:
      - DATABASE_URL=postgres://admin:ohzomoeilijkwachtwoord@imageservicedb:5432/photoprestige
      - PORT=5672
    restart: always
  imageservicedb:
    image: postgres:16
    volumes:
      - ./data/imageservice:/var/lib/postgresql/data
      - ./databasescripts/imageservice.sql:/docker-entrypoint-initdb.d/init-db.sql
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ohzomoeilijkwachtwoord
      POSTGRES_DB: photoprestige
    restart: always
  authservice:
    build:
      context: ./authservice
      dockerfile: /Dockerfile
    volumes:
      - ./authservice:/app
    depends_on:
      - imageservicedb
    environment:
      - DATABASE_URL=postgres://admin:ohzomoeilijkwachtwoord@authservicedb:5432/photoprestige
      - PORT=5672
    restart: always
  authservicedb:
    image: postgres:16
    volumes:
      - ./data/authservice:/var/lib/postgresql/data
      - ./databasescripts/authservice.sql:/docker-entrypoint-initdb.d/init-db.sql
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ohzomoeilijkwachtwoord
      POSTGRES_DB: photoprestige
    restart: always
  targetservice:
    build:
      context: ./targetservice
      dockerfile: /Dockerfile
    volumes:
      - ./targetservice:/app
    depends_on:
      - targetservicedb
    environment:
      - DATABASE_URL=postgres://admin:ohzomoeilijkwachtwoord@targetservicedb:5432/photoprestige
      - PORT=5672
    restart: always
  targetservicedb:
    image: postgres:16
    volumes:
      - ./data/targetservice:/var/lib/postgresql/data
      - ./databasescripts/targetservice.sql:/docker-entrypoint-initdb.d/init-db.sql
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: ohzomoeilijkwachtwoord
      POSTGRES_DB: photoprestige
    restart: always
  mailhog:
    image: mailhog/mailhog
    environment:
      MH_STORAGE: maildir
      MH_MAILDIR_PATH: /home/mailhog
    volumes:
      - ./data/mailhog:/home/mailhog
    ports:
      - "1025:1025" # SMTP server
      - "8025:8025" # Web interface
    restart: always
  rabbitmq:
    image: "rabbitmq:3.13-management"
    volumes:
      - "./data/rabbitmq:/var/lib/rabbitmq"
    ports:
      - "5672:5672" # AMQP protocol port
      - "15672:15672" # Web management interface
    environment:
      RABBITMQ_DEFAULT_USER: "user"
      RABBITMQ_DEFAULT_PASS: "password"
    restart: always
